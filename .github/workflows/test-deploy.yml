name: Test Environment Deploy (No Tags)

# è§¦å‘æ¡ä»¶ï¼šä»…æ‰‹åŠ¨æŒ‰é’®è§¦å‘ï¼ˆæ— éœ€æ ‡ç­¾ï¼‰
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'æ“ä½œç±»åž‹'
        required: true
        type: choice
        options:
          - åŠ å…¥TestçŽ¯å¢ƒ
          - é€€å‡ºTestçŽ¯å¢ƒ
      featureBranch:
        description: 'Featureåˆ†æ”¯åï¼ˆæ ¼å¼ï¼šfeature/xxxï¼Œå¦‚ feature/user-loginï¼‰'
        required: true
        default: 'feature/user-login'
      # å¯é€‰ï¼šæ˜¯å¦ç«‹å³éƒ¨ç½²ï¼ˆé»˜è®¤æ˜¯ï¼‰
      deployNow:
        description: 'æ“ä½œåŽç«‹å³éƒ¨ç½²TestçŽ¯å¢ƒï¼Ÿ'
        required: true
        type: boolean
        default: true

jobs:
  # æ­¥éª¤1ï¼šæ›´æ–°ã€Œé›†æˆæ¸…å•ã€ï¼ˆfeatures.jsonï¼‰
  update-integration-list:
    runs-on: ubuntu-latest
    outputs:
      currentFeatures: ${{ steps.get-features.outputs.list }}  # è¾“å‡ºå½“å‰å¾…é›†æˆçš„åˆ†æ”¯åˆ—è¡¨
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–æ‰€æœ‰åˆ†æ”¯
          token: ${{ secrets.GITHUB_TOKEN }}  # æ˜¾å¼æŒ‡å®šä»¤ç‰Œï¼Œç¡®ä¿pushæƒé™

      # æ–°å¢žï¼šå®‰è£…jqï¼ˆè§£æžJSONå¿…éœ€ï¼Œä¿®å¤"jq: command not found"é”™è¯¯ï¼‰
      - name: Install jq (JSON parser)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: ç¡®ä¿çŠ¶æ€æ–‡ä»¶ç›®å½•å­˜åœ¨
        run: mkdir -p .test-env

      - name: åˆå§‹åŒ–çŠ¶æ€æ–‡ä»¶ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
        run: |
          if [ ! -f .test-env/features.json ]; then
            echo "[]" > .test-env/features.json
            echo "âœ… åˆå§‹åŒ–é›†æˆæ¸…å•æ–‡ä»¶"
          fi

      - name: æ›´æ–°é›†æˆæ¸…å•ï¼ˆåŠ å…¥/é€€å‡ºåˆ†æ”¯ï¼‰
        id: update-list
        run: |
          # è¯»å–å½“å‰é›†æˆæ¸…å•
          CURRENT_FEATURES=$(cat .test-env/features.json | jq -r '.[]')
          TARGET_BRANCH="${{ github.event.inputs.featureBranch }}"
          ACTION="${{ github.event.inputs.action }}"

          # éªŒè¯åˆ†æ”¯æ ¼å¼ï¼ˆå¿…é¡»æ˜¯ feature/xxxï¼‰
          if [[ ! $TARGET_BRANCH =~ ^feature/ ]]; then
            echo "âŒ åˆ†æ”¯æ ¼å¼é”™è¯¯ï¼å¿…é¡»ä»¥ feature/ å¼€å¤´"
            exit 1
          fi

          # åŠ å…¥ï¼šåˆ†æ”¯ä¸åœ¨åˆ—è¡¨ä¸­åˆ™æ·»åŠ 
          if [ "$ACTION" == "åŠ å…¥TestçŽ¯å¢ƒ" ]; then
            if echo "$CURRENT_FEATURES" | grep -q "$TARGET_BRANCH"; then
              echo "âš ï¸  åˆ†æ”¯ $TARGET_BRANCH å·²åœ¨TestçŽ¯å¢ƒä¸­ï¼Œæ— éœ€é‡å¤åŠ å…¥"
              NEW_LIST=$(echo "$CURRENT_FEATURES" | jq -R . | jq -s .)
            else
              NEW_LIST=$(echo "$CURRENT_FEATURES" | jq -R . | jq -s '. + ["'$TARGET_BRANCH'"]')
              echo "âœ… å·²å°† $TARGET_BRANCH åŠ å…¥TestçŽ¯å¢ƒé›†æˆæ¸…å•"
            fi
          # é€€å‡ºï¼šåˆ†æ”¯åœ¨åˆ—è¡¨ä¸­åˆ™åˆ é™¤
          else
            NEW_LIST=$(echo "$CURRENT_FEATURES" | jq -R . | jq -s 'map(select(. != "'$TARGET_BRANCH'"))')
            echo "âœ… å·²å°† $TARGET_BRANCH é€€å‡ºTestçŽ¯å¢ƒé›†æˆæ¸…å•"
          fi

          # å†™å…¥æ›´æ–°åŽçš„æ¸…å•åˆ°æ–‡ä»¶ï¼ˆæ ¼å¼åŒ–JSONï¼Œä¾¿äºŽæŸ¥çœ‹ï¼‰
          echo "$NEW_LIST" | jq . > .test-env/features.json
          # è¾“å‡ºå½“å‰æ¸…å•ï¼ˆä¾›åŽç»­æ­¥éª¤ä½¿ç”¨ï¼‰
          echo "list=$NEW_LIST" >> $GITHUB_OUTPUT

      - name: æäº¤æ›´æ–°åŽçš„é›†æˆæ¸…å•
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .test-env/features.json
          # è‹¥æ–‡ä»¶æ— å˜æ›´ï¼ˆå¦‚é‡å¤åŠ å…¥ï¼‰ï¼Œåˆ™ä¸æäº¤
          if git diff --cached --quiet; then
            echo "â„¹ï¸  é›†æˆæ¸…å•æ— å˜æ›´ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "TestEnv: ${{ github.event.inputs.action }} ${{ github.event.inputs.featureBranch }}"
            git push origin ${{ github.ref }}  # æŽ¨é€åˆ°å½“å‰åˆ†æ”¯ï¼ˆmasterï¼‰
          fi

      - name: è¾“å‡ºæœ€ç»ˆé›†æˆæ¸…å•
        id: get-features
        run: |
          FINAL_LIST=$(cat .test-env/features.json)
          echo "list=$FINAL_LIST" >> $GITHUB_OUTPUT
          echo "å½“å‰å¾…é›†æˆåˆ°TestçŽ¯å¢ƒçš„åˆ†æ”¯ï¼š$FINAL_LIST"

  # æ­¥éª¤2ï¼šåˆ›å»ºä¸´æ—¶Teståˆ†æ”¯ï¼ˆèšåˆæ¸…å•ä¸­çš„æ‰€æœ‰Featureï¼‰
  create-temp-test-branch:
    runs-on: ubuntu-latest
    needs: update-integration-list
    # ä¿®å¤è¯­æ³•é”™è¯¯ï¼šç”¨lengthåˆ¤æ–­æ•°ç»„éžç©º
    if: ${{ github.event.inputs.deployNow == true && length(fromJSON(needs.update-integration-list.outputs.currentFeatures)) > 0 }}
    outputs:
      tempBranch: ${{ steps.create-branch.outputs.name }}
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master  # åŸºäºŽmasteråˆ†æ”¯åˆ›å»ºä¸´æ—¶Teståˆ†æ”¯
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½®Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: åˆ›å»ºä¸´æ—¶Teståˆ†æ”¯
        id: create-branch
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          TEMP_BRANCH="temp-test-$TIMESTAMP"
          git checkout -b $TEMP_BRANCH master
          echo "name=$TEMP_BRANCH" >> $GITHUB_OUTPUT
          echo "âœ… åˆ›å»ºä¸´æ—¶Teståˆ†æ”¯ï¼š$TEMP_BRANCH"

      - name: åˆå¹¶æ¸…å•ä¸­çš„æ‰€æœ‰Featureåˆ†æ”¯
        run: |
          # è§£æžé›†æˆæ¸…å•ä¸­çš„åˆ†æ”¯åˆ—è¡¨
          FEATURES=$(echo '${{ needs.update-integration-list.outputs.currentFeatures }}' | jq -r '.[]')
          for BRANCH in $FEATURES; do
            echo "ðŸ”„ æ­£åœ¨åˆå¹¶åˆ†æ”¯ï¼š$BRANCH"
            # æ‹‰å–è¿œç¨‹Featureåˆ†æ”¯ï¼ˆé¿å…æœ¬åœ°æ— è¯¥åˆ†æ”¯ï¼‰
            git fetch origin $BRANCH:refs/remotes/origin/$BRANCH
            # åˆå¹¶å¤±è´¥ï¼ˆå†²çªï¼‰åˆ™ç»ˆæ­¢ï¼Œæç¤ºæ‰‹åŠ¨è§£å†³
            if ! git merge origin/$BRANCH --no-edit; then
              echo "âŒ åˆå¹¶ $BRANCH æ—¶å‘ç”Ÿå†²çªï¼Œè¯·æ‰‹åŠ¨è§£å†³åŽé‡æ–°è§¦å‘éƒ¨ç½²"
              exit 1
            fi
          done
          # æŽ¨é€ä¸´æ—¶åˆ†æ”¯åˆ°è¿œç¨‹ï¼ˆä¾¿äºŽè°ƒè¯•å’ŒåŽç»­éƒ¨ç½²ï¼‰
          git push -u origin $TEMP_BRANCH

  # æ­¥éª¤3ï¼šéƒ¨ç½²åˆ°TestçŽ¯å¢ƒï¼ˆæ›¿æ¢ä¸ºä½ çš„å®žé™…éƒ¨ç½²å‘½ä»¤ï¼‰
  deploy-to-test:
    runs-on: ubuntu-latest
    needs: create-temp-test-branch
    steps:
      - name: Checkout ä¸´æ—¶Teståˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-temp-test-branch.outputs.tempBranch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: éƒ¨ç½²TestçŽ¯å¢ƒ
        env:
          # æµ‹è¯•çŽ¯å¢ƒé…ç½®ï¼ˆä»ŽGitHub Secretsè¯»å–ï¼Œéœ€æå‰åœ¨ä»“åº“è®¾ç½®ï¼‰
          TEST_DB_URL: ${{ secrets.TEST_DB_URL }}
          TEST_API_KEY: ${{ secrets.TEST_API_KEY }}
          # è‹¥éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼Œéœ€æ·»åŠ SSHç›¸å…³å¯†é’¥ï¼ˆç¤ºä¾‹ï¼‰
          # TEST_SERVER_SSH_KEY: ${{ secrets.TEST_SERVER_SSH_KEY }}
          # TEST_SERVER_HOST: ${{ secrets.TEST_SERVER_HOST }}
          # TEST_SERVER_USER: ${{ secrets.TEST_SERVER_USER }}
        run: |
          echo "ðŸš€ å¼€å§‹éƒ¨ç½²ä¸´æ—¶åˆ†æ”¯ ${{ needs.create-temp-test-branch.outputs.tempBranch }} åˆ°TestçŽ¯å¢ƒ"
          
          # ===================== æ›¿æ¢ä¸ºä½ çš„éƒ¨ç½²å‘½ä»¤ =====================
          # ç¤ºä¾‹1ï¼šå‰ç«¯é¡¹ç›®ï¼ˆå¦‚Vue/Reactï¼‰éƒ¨ç½²åˆ°Vercel Preview
          # npm install
          # npm run build
          # npm install -g vercel
          # vercel deploy --preview --token ${{ secrets.VERCEL_TOKEN }} --env TEST_DB_URL=$TEST_DB_URL
          
          # ç¤ºä¾‹2ï¼šåŽç«¯é¡¹ç›®ï¼ˆå¦‚Node.js/Pythonï¼‰éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨ï¼ˆSSHæ–¹å¼ï¼‰
          # echo "$TEST_SERVER_SSH_KEY" > ~/.ssh/test_server_key
          # chmod 600 ~/.ssh/test_server_key
          # ssh -o StrictHostKeyChecking=no -i ~/.ssh/test_server_key $TEST_SERVER_USER@$TEST_SERVER_HOST << EOF
          #   cd /var/app/test  # æµ‹è¯•æœåŠ¡å™¨é¡¹ç›®ç›®å½•
          #   git pull origin ${{ needs.create-temp-test-branch.outputs.tempBranch }}
          #   npm install  # æˆ– pip install -r requirements.txt
          #   pm2 restart app  # æˆ– systemctl restart test-service
          # EOF
          
          # ç¤ºä¾‹3ï¼šDockeréƒ¨ç½²ï¼ˆæœ¬åœ°æž„å»ºé•œåƒæŽ¨é€åˆ°æµ‹è¯•çŽ¯å¢ƒï¼‰
          # docker build -t test-app:${{ needs.create-temp-test-branch.outputs.tempBranch }} .
          # docker tag test-app:${{ needs.create-temp-test-branch.outputs.tempBranch }} ä½ çš„é•œåƒä»“åº“åœ°å€
          # docker push ä½ çš„é•œåƒä»“åº“åœ°å€
          # ssh -o StrictHostKeyChecking=no $TEST_SERVER_USER@$TEST_SERVER_HOST "docker pull ä½ çš„é•œåƒä»“åº“åœ°å€ && docker-compose restart test-app"
          # ==============================================================

          echo "âœ… TestçŽ¯å¢ƒéƒ¨ç½²å‘½ä»¤æ‰§è¡Œå®Œæˆï¼"

      - name: éƒ¨ç½²ç»“æžœé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        run: |
          # æ›¿æ¢ä¸ºä½ çš„é€šçŸ¥æ–¹å¼ï¼ˆä¼ä¸šå¾®ä¿¡/Slack/é‚®ä»¶ç­‰ï¼‰
          NOTIFY_CONTENT="âœ… TestçŽ¯å¢ƒæ›´æ–°æˆåŠŸï¼
          - æ“ä½œç±»åž‹ï¼š${{ github.event.inputs.action }}
          - ç›®æ ‡åˆ†æ”¯ï¼š${{ github.event.inputs.featureBranch }}
          - ä¸´æ—¶Teståˆ†æ”¯ï¼š${{ needs.create-temp-test-branch.outputs.tempBranch }}
          - å½“å‰é›†æˆåˆ†æ”¯ï¼š${{ needs.update-integration-list.outputs.currentFeatures }}"
          
          # ä¼ä¸šå¾®ä¿¡é€šçŸ¥ç¤ºä¾‹ï¼ˆéœ€åœ¨GitHub Secretsæ·»åŠ  WECHAT_WEBHOOKï¼‰
          # curl -H "Content-Type: application/json" -d "{
          #   \"msgtype\":\"text\",
          #   \"text\":{\"content\":\"$NOTIFY_CONTENT\"}
          # }" ${{ secrets.WECHAT_WEBHOOK }}
          
          echo "$NOTIFY_CONTENT"
