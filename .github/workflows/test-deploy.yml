name: Test Environment Deploy (No Tags)

# è§¦å‘æ¡ä»¶ï¼šä»…æ‰‹åŠ¨æŒ‰é’®è§¦å‘ï¼ˆæ— éœ€æ ‡ç­¾ï¼‰
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'æ“ä½œç±»å‹'
        required: true
        type: choice
        options:
          - åŠ å…¥Testç¯å¢ƒ
          - é€€å‡ºTestç¯å¢ƒ
      featureBranch:
        description: 'Featureåˆ†æ”¯åï¼ˆæ ¼å¼ï¼šfeature/xxxï¼Œå¦‚ feature/user-loginï¼‰'
        required: true
        default: 'feature/user-login'
      # å¯é€‰ï¼šæ˜¯å¦ç«‹å³éƒ¨ç½²ï¼ˆé»˜è®¤æ˜¯ï¼‰
      deployNow:
        description: 'æ“ä½œåç«‹å³éƒ¨ç½²Testç¯å¢ƒï¼Ÿ'
        required: true
        type: boolean
        default: true

jobs:
  # æ­¥éª¤1ï¼šæ›´æ–°ã€Œé›†æˆæ¸…å•ã€ï¼ˆfeatures.jsonï¼‰
  update-integration-list:
    runs-on: ubuntu-latest
    outputs:
      currentFeatures: ${{ steps.get-features.outputs.list }}  # è¾“å‡ºå½“å‰å¾…é›†æˆçš„åˆ†æ”¯åˆ—è¡¨
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–æ‰€æœ‰åˆ†æ”¯

      - name: ç¡®ä¿çŠ¶æ€æ–‡ä»¶ç›®å½•å­˜åœ¨
        run: mkdir -p .test-env

      - name: åˆå§‹åŒ–çŠ¶æ€æ–‡ä»¶ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
        run: |
          if [ ! -f .test-env/features.json ]; then
            echo "[]" > .test-env/features.json
            echo "âœ… åˆå§‹åŒ–é›†æˆæ¸…å•æ–‡ä»¶"
          fi

      - name: æ›´æ–°é›†æˆæ¸…å•ï¼ˆåŠ å…¥/é€€å‡ºåˆ†æ”¯ï¼‰
        id: update-list
        run: |
          # è¯»å–å½“å‰é›†æˆæ¸…å•
          CURRENT_FEATURES=$(cat .test-env/features.json | jq -r '.[]')
          TARGET_BRANCH="${{ github.event.inputs.featureBranch }}"
          ACTION="${{ github.event.inputs.action }}"

          # éªŒè¯åˆ†æ”¯æ ¼å¼ï¼ˆå¿…é¡»æ˜¯ feature/xxxï¼‰
          if [[ ! $TARGET_BRANCH =~ ^feature/ ]]; then
            echo "âŒ åˆ†æ”¯æ ¼å¼é”™è¯¯ï¼å¿…é¡»ä»¥ feature/ å¼€å¤´"
            exit 1
          fi

          # åŠ å…¥ï¼šåˆ†æ”¯ä¸åœ¨åˆ—è¡¨ä¸­åˆ™æ·»åŠ 
          if [ "$ACTION" == "åŠ å…¥Testç¯å¢ƒ" ]; then
            if echo "$CURRENT_FEATURES" | grep -q "$TARGET_BRANCH"; then
              echo "âš ï¸  åˆ†æ”¯ $TARGET_BRANCH å·²åœ¨Testç¯å¢ƒä¸­ï¼Œæ— éœ€é‡å¤åŠ å…¥"
              NEW_LIST=$(echo "$CURRENT_FEATURES" | jq -R . | jq -s .)
            else
              NEW_LIST=$(echo "$CURRENT_FEATURES" | jq -R . | jq -s '. + ["'$TARGET_BRANCH'"]')
              echo "âœ… å·²å°† $TARGET_BRANCH åŠ å…¥Testç¯å¢ƒé›†æˆæ¸…å•"
            fi
          # é€€å‡ºï¼šåˆ†æ”¯åœ¨åˆ—è¡¨ä¸­åˆ™åˆ é™¤
          else
            NEW_LIST=$(echo "$CURRENT_FEATURES" | jq -R . | jq -s 'map(select(. != "'$TARGET_BRANCH'"))')
            echo "âœ… å·²å°† $TARGET_BRANCH é€€å‡ºTestç¯å¢ƒé›†æˆæ¸…å•"
          fi

          # å†™å…¥æ›´æ–°åçš„æ¸…å•åˆ°æ–‡ä»¶
          echo "$NEW_LIST" | jq . > .test-env/features.json
          # è¾“å‡ºå½“å‰æ¸…å•ï¼ˆä¾›åç»­æ­¥éª¤ä½¿ç”¨ï¼‰
          echo "list=$NEW_LIST" >> $GITHUB_OUTPUT

      - name: æäº¤æ›´æ–°åçš„é›†æˆæ¸…å•
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .test-env/features.json
          # è‹¥æ–‡ä»¶æ— å˜æ›´ï¼ˆå¦‚é‡å¤åŠ å…¥ï¼‰ï¼Œåˆ™ä¸æäº¤
          if git diff --cached --quiet; then
            echo "â„¹ï¸  é›†æˆæ¸…å•æ— å˜æ›´ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "TestEnv: ${{ github.event.inputs.action }} ${{ github.event.inputs.featureBranch }}"
            git push origin ${{ github.ref }}  # æ¨é€åˆ°å½“å‰åˆ†æ”¯ï¼ˆè§¦å‘å·¥ä½œæµçš„åˆ†æ”¯ï¼Œé€šå¸¸æ˜¯mainï¼‰
          fi

      - name: è¾“å‡ºæœ€ç»ˆé›†æˆæ¸…å•
        id: get-features
        run: |
          FINAL_LIST=$(cat .test-env/features.json)
          echo "list=$FINAL_LIST" >> $GITHUB_OUTPUT
          echo "å½“å‰å¾…é›†æˆåˆ°Testç¯å¢ƒçš„åˆ†æ”¯ï¼š$FINAL_LIST"

  # æ­¥éª¤2ï¼šåˆ›å»ºä¸´æ—¶Teståˆ†æ”¯ï¼ˆèšåˆæ¸…å•ä¸­çš„æ‰€æœ‰Featureï¼‰
  create-temp-test-branch:
    runs-on: ubuntu-latest
    needs: update-integration-list
    if: ${{ github.event.inputs.deployNow == true && fromJSON(needs.update-integration-list.outputs.currentFeatures) != [] }}
    outputs:
      tempBranch: ${{ steps.create-branch.outputs.name }}
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main  # åŸºäºmainåˆ†æ”¯åˆ›å»ºä¸´æ—¶Teståˆ†æ”¯

      - name: é…ç½®Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: åˆ›å»ºä¸´æ—¶Teståˆ†æ”¯
        id: create-branch
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          TEMP_BRANCH="temp-test-$TIMESTAMP"
          git checkout -b $TEMP_BRANCH main
          echo "name=$TEMP_BRANCH" >> $GITHUB_OUTPUT
          echo "âœ… åˆ›å»ºä¸´æ—¶Teståˆ†æ”¯ï¼š$TEMP_BRANCH"

      - name: åˆå¹¶æ¸…å•ä¸­çš„æ‰€æœ‰Featureåˆ†æ”¯
        run: |
          FEATURES=$(echo '${{ needs.update-integration-list.outputs.currentFeatures }}' | jq -r '.[]')
          for BRANCH in $FEATURES; do
            echo "ğŸ”„ æ­£åœ¨åˆå¹¶åˆ†æ”¯ï¼š$BRANCH"
            git fetch origin $BRANCH:refs/remotes/origin/$BRANCH
            # åˆå¹¶å¤±è´¥ï¼ˆå†²çªï¼‰åˆ™ç»ˆæ­¢ï¼Œæç¤ºæ‰‹åŠ¨è§£å†³
            if ! git merge origin/$BRANCH --no-edit; then
              echo "âŒ åˆå¹¶ $BRANCH æ—¶å‘ç”Ÿå†²çªï¼Œè¯·æ‰‹åŠ¨è§£å†³åé‡æ–°è§¦å‘éƒ¨ç½²"
              exit 1
            fi
          done
          # æ¨é€ä¸´æ—¶åˆ†æ”¯åˆ°è¿œç¨‹ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
          git push -u origin $TEMP_BRANCH

  # æ­¥éª¤3ï¼šéƒ¨ç½²åˆ°Testç¯å¢ƒï¼ˆä¸ä¹‹å‰é€»è¾‘ä¸€è‡´ï¼Œæ›¿æ¢ä¸ºä½ çš„éƒ¨ç½²å‘½ä»¤ï¼‰
  deploy-to-test:
    runs-on: ubuntu-latest
    needs: create-temp-test-branch
    steps:
      - name: Checkout ä¸´æ—¶Teståˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-temp-test-branch.outputs.tempBranch }}
          fetch-depth: 0

      - name: éƒ¨ç½²Testç¯å¢ƒ
        env:
          TEST_DB_URL: ${{ secrets.TEST_DB_URL }}
        run: |
          echo "ğŸš€ éƒ¨ç½²ä¸´æ—¶åˆ†æ”¯ ${{ needs.create-temp-test-branch.outputs.tempBranch }} åˆ°Testç¯å¢ƒ"
          # æ›¿æ¢ä¸ºä½ çš„å®é™…éƒ¨ç½²å‘½ä»¤ï¼ˆå¦‚SSHã€äº‘å‚å•†CLIç­‰ï¼‰
          # npm install && npm run build && vercel deploy --preview --token ${{ secrets.VERCEL_TOKEN }}

      - name: é€šçŸ¥éƒ¨ç½²å®Œæˆ
        run: |
          echo "âœ… Testç¯å¢ƒéƒ¨ç½²å®Œæˆï¼å½“å‰é›†æˆåˆ†æ”¯ï¼š${{ needs.update-integration-list.outputs.currentFeatures }}"
          # å¯é€‰ï¼šä¼ä¸šå¾®ä¿¡/Slacké€šçŸ¥ï¼ˆæ›¿æ¢ä¸ºä½ çš„webhookï¼‰
          # curl -H "Content-Type: application/json" -d '{"msgtype":"text","text":{"content":"Testç¯å¢ƒæ›´æ–°ï¼š${{ needs.update-integration-list.outputs.currentFeatures }}"}}' ${{ secrets.WECHAT_WEBHOOK }}
