name: Test Environment Deploy (No Tags + No Master Pollution)

# è§¦å‘æ¡ä»¶ï¼šä»…æ‰‹åŠ¨æŒ‰é’®è§¦å‘ï¼ˆæ— éœ€æ ‡ç­¾ï¼‰
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'æ“ä½œç±»å‹'
        required: true
        type: choice
        options:
          - åŠ å…¥Testç¯å¢ƒ
          - é€€å‡ºTestç¯å¢ƒ
      featureBranch:
        description: 'Featureåˆ†æ”¯åï¼ˆæ ¼å¼ï¼šfeature/xxxï¼Œå¦‚ feature/user-loginï¼‰'
        required: true
        default: 'feature/user-login'
      # å¯é€‰ï¼šæ˜¯å¦ç«‹å³éƒ¨ç½²ï¼ˆé»˜è®¤æ˜¯ï¼‰
      deployNow:
        description: 'æ“ä½œåç«‹å³éƒ¨ç½²Testç¯å¢ƒï¼Ÿ'
        required: true
        type: boolean
        default: true

jobs:
  # æ­¥éª¤1ï¼šæ›´æ–°ã€Œé›†æˆæ¸…å•ã€ï¼ˆç¼“å­˜å­˜å‚¨ï¼Œä¸æäº¤åˆ°masterï¼‰
  update-integration-list:
    runs-on: ubuntu-latest
    outputs:
      currentFeatures: ${{ steps.get-features.outputs.list }}  # è¾“å‡ºå½“å‰å¾…é›†æˆçš„åˆ†æ”¯åˆ—è¡¨
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–æ‰€æœ‰åˆ†æ”¯
          token: ${{ secrets.GITHUB_TOKEN }}  # æ˜¾å¼æŒ‡å®šä»¤ç‰Œï¼Œç¡®ä¿æ“ä½œæƒé™

      # å®‰è£…jqï¼ˆè§£æJSONå¿…éœ€ï¼‰
      - name: Install jq (JSON parser)
        run: sudo apt-get update && sudo apt-get install -y jq

      # å…³é”®ï¼šä»GitHubç¼“å­˜æ¢å¤é›†æˆæ¸…å•ï¼ˆé¿å…æäº¤åˆ°masterï¼‰
      - name: æ¢å¤é›†æˆæ¸…å•ç¼“å­˜
        uses: actions/cache@v3
        id: cache-features
        with:
          path: .test-env/features.json  # ç¼“å­˜çš„æ–‡ä»¶è·¯å¾„
          key: ${{ runner.os }}-test-env-features  # å”¯ä¸€ç¼“å­˜æ ‡è¯†ï¼ˆæŒ‰ç³»ç»ŸåŒºåˆ†ï¼‰
          restore-keys: |
            ${{ runner.os }}-test-env-features

      # åˆå§‹åŒ–é›†æˆæ¸…å•ï¼ˆç¼“å­˜æœªå‘½ä¸­æ—¶åˆ›å»ºç©ºæ–‡ä»¶ï¼‰
      - name: åˆå§‹åŒ–é›†æˆæ¸…å•ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰
        run: |
          mkdir -p .test-env  # ç¡®ä¿ç›®å½•å­˜åœ¨
          if [ ! -f .test-env/features.json ]; then
            echo "[]" > .test-env/features.json
            echo "âœ… åˆå§‹åŒ–é›†æˆæ¸…å•ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰"
          fi

      # æ›´æ–°é›†æˆæ¸…å•ï¼ˆåŠ å…¥/é€€å‡ºåˆ†æ”¯ï¼‰
      - name: æ›´æ–°é›†æˆæ¸…å•é€»è¾‘
        id: update-list
        run: |
          # è¯»å–å½“å‰æ¸…å•ï¼ˆå‹ç¼©JSONï¼Œé¿å…æ ¼å¼é—®é¢˜ï¼‰
          CURRENT_JSON=$(cat .test-env/features.json | jq -c .)
          TARGET_BRANCH="${{ github.event.inputs.featureBranch }}"
          ACTION="${{ github.event.inputs.action }}"

          # éªŒè¯åˆ†æ”¯æ ¼å¼ï¼ˆå¿…é¡»æ˜¯ feature/xxxï¼‰
          if [[ ! $TARGET_BRANCH =~ ^feature/ ]]; then
            echo "âŒ åˆ†æ”¯æ ¼å¼é”™è¯¯ï¼å¿…é¡»ä»¥ feature/ å¼€å¤´"
            exit 1
          fi

          # åŠ å…¥åˆ†æ”¯ï¼šä¸å­˜åœ¨åˆ™æ·»åŠ 
          if [ "$ACTION" == "åŠ å…¥Testç¯å¢ƒ" ]; then
            NEW_JSON=$(echo "$CURRENT_JSON" | jq --arg branch "$TARGET_BRANCH" -c '
              if index($branch) then . else . + [$branch] end
            ')
            echo "âœ… å·²å°† $TARGET_BRANCH åŠ å…¥Testç¯å¢ƒé›†æˆæ¸…å•"
          # é€€å‡ºåˆ†æ”¯ï¼šå­˜åœ¨åˆ™åˆ é™¤
          else
            NEW_JSON=$(echo "$CURRENT_JSON" | jq --arg branch "$TARGET_BRANCH" -c '
              map(select(. != $branch))
            ')
            echo "âœ… å·²å°† $TARGET_BRANCH é€€å‡ºTestç¯å¢ƒé›†æˆæ¸…å•"
          fi

          # å†™å…¥æ›´æ–°åçš„æ¸…å•åˆ°æœ¬åœ°æ–‡ä»¶ï¼ˆåç»­å­˜å…¥ç¼“å­˜ï¼‰
          echo "$NEW_JSON" | jq . > .test-env/features.json
          # è¾“å‡ºç»™åç»­æ­¥éª¤ä½¿ç”¨
          echo "list=$NEW_JSON" >> $GITHUB_OUTPUT

      # å…³é”®ï¼šä¿å­˜æ›´æ–°åçš„æ¸…å•åˆ°ç¼“å­˜ï¼ˆè¦†ç›–æ—§ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡èƒ½è¯»å–ï¼‰
      - name: ä¿å­˜é›†æˆæ¸…å•åˆ°ç¼“å­˜
        if: always()  # å³ä½¿å‰é¢æ­¥éª¤å¤±è´¥ï¼Œä¹Ÿä¿å­˜ç¼“å­˜ï¼ˆé¿å…æ•°æ®ä¸¢å¤±ï¼‰
        uses: actions/cache/save@v3
        with:
          path: .test-env/features.json
          key: ${{ runner.os }}-test-env-features

      # è¾“å‡ºæœ€ç»ˆé›†æˆæ¸…å•ï¼ˆæ—¥å¿—å¯è§ï¼‰
      - name: è¾“å‡ºå½“å‰é›†æˆåˆ†æ”¯
        id: get-features
        run: |
          FINAL_LIST=$(cat .test-env/features.json | jq -c .)
          echo "list=$FINAL_LIST" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ å½“å‰å¾…é›†æˆåˆ°Testç¯å¢ƒçš„åˆ†æ”¯ï¼š$FINAL_LIST"

  # æ­¥éª¤2ï¼šåˆ›å»ºä¸´æ—¶Teståˆ†æ”¯ï¼ˆèšåˆæ‰€æœ‰Featureåˆ†æ”¯ï¼‰
  create-temp-test-branch:
    runs-on: ubuntu-latest
    needs: update-integration-list
    # å…¼å®¹æ‰€æœ‰Actionsç‰ˆæœ¬çš„æ¡ä»¶åˆ¤æ–­ï¼ˆéç©ºæ‰æ‰§è¡Œï¼‰
    if: ${{ github.event.inputs.deployNow == true && join(fromJSON(needs.update-integration-list.outputs.currentFeatures)) != '' }}
    outputs:
      tempBranch: ${{ steps.create-branch.outputs.name }}
    steps:
      - name: Checkout ä»£ç ï¼ˆåŸºäºmasteråˆ†æ”¯ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½®Gitèº«ä»½ï¼ˆç”¨äºåˆ›å»ºåˆ†æ”¯å’Œæäº¤ï¼‰
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: åˆ›å»ºä¸´æ—¶Teståˆ†æ”¯ï¼ˆæ—¶é—´æˆ³ç¡®ä¿å”¯ä¸€ï¼‰
        id: create-branch
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          TEMP_BRANCH="temp-test-$TIMESTAMP"
          git checkout -b $TEMP_BRANCH master
          echo "name=$TEMP_BRANCH" >> $GITHUB_OUTPUT
          echo "âœ… åˆ›å»ºä¸´æ—¶Teståˆ†æ”¯ï¼š$TEMP_BRANCH"

      - name: åˆå¹¶é›†æˆæ¸…å•ä¸­çš„æ‰€æœ‰Featureåˆ†æ”¯
        run: |
          # è§£æç¼“å­˜ä¸­çš„åˆ†æ”¯åˆ—è¡¨
          FEATURES=$(echo '${{ needs.update-integration-list.outputs.currentFeatures }}' | jq -r '.[]')
          for BRANCH in $FEATURES; do
            # è·³è¿‡ç©ºå­—ç¬¦ä¸²ï¼ˆé˜²æ­¢å¼‚å¸¸ï¼‰
            if [ -z "$BRANCH" ]; then continue; fi
            echo "ğŸ”„ æ­£åœ¨åˆå¹¶åˆ†æ”¯ï¼š$BRANCH"
            # æ‹‰å–è¿œç¨‹Featureåˆ†æ”¯ï¼ˆé¿å…æœ¬åœ°æ— è¯¥åˆ†æ”¯ï¼‰
            git fetch origin $BRANCH:refs/remotes/origin/$BRANCH
            # åˆå¹¶å¤±è´¥ï¼ˆå†²çªï¼‰åˆ™ç»ˆæ­¢ï¼Œæç¤ºæ‰‹åŠ¨è§£å†³
            if ! git merge origin/$BRANCH --no-edit; then
              echo "âŒ åˆå¹¶ $BRANCH æ—¶å‘ç”Ÿå†²çªï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤è§£å†³ï¼š"
              echo "1. æœ¬åœ°æ‹‰å–ä¸´æ—¶åˆ†æ”¯ï¼šgit pull origin ${{ steps.create-branch.outputs.name }}"
              echo "2. è§£å†³å†²çªï¼šgit mergetool æˆ–æ‰‹åŠ¨ç¼–è¾‘å†²çªæ–‡ä»¶"
              echo "3. æäº¤å¹¶æ¨é€ï¼šgit add . && git commit -m 'fix: resolve merge conflict' && git push"
              echo "4. é‡æ–°è§¦å‘å·¥ä½œæµéƒ¨ç½²"
              exit 1
            fi
          done
          # æ¨é€ä¸´æ—¶åˆ†æ”¯åˆ°è¿œç¨‹ï¼ˆä¾¿äºéƒ¨ç½²å’Œè°ƒè¯•ï¼‰
          git push -u origin ${{ steps.create-branch.outputs.name }}

  # æ­¥éª¤3ï¼šéƒ¨ç½²åˆ°Testç¯å¢ƒï¼ˆæ›¿æ¢ä¸ºä½ çš„å®é™…éƒ¨ç½²å‘½ä»¤ï¼‰
  deploy-to-test:
    runs-on: ubuntu-latest
    needs: create-temp-test-branch
    steps:
      - name: Checkout ä¸´æ—¶Teståˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-temp-test-branch.outputs.tempBranch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: éƒ¨ç½²åˆ°Testç¯å¢ƒ
        env:
          # æµ‹è¯•ç¯å¢ƒæ•æ„Ÿé…ç½®ï¼ˆä»GitHub Secretsè¯»å–ï¼Œéœ€æå‰è®¾ç½®ï¼‰
          TEST_DB_URL: ${{ secrets.TEST_DB_URL }}
          TEST_API_KEY: ${{ secrets.TEST_API_KEY }}
          # è‹¥éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼Œæ·»åŠ SSHç›¸å…³é…ç½®ï¼ˆç¤ºä¾‹ï¼‰
          # TEST_SERVER_SSH_KEY: ${{ secrets.TEST_SERVER_SSH_KEY }}
          # TEST_SERVER_HOST: ${{ secrets.TEST_SERVER_HOST }}
          # TEST_SERVER_USER: ${{ secrets.TEST_SERVER_USER }}
          # TEST_SERVER_APP_DIR: ${{ secrets.TEST_SERVER_APP_DIR }}  # æœåŠ¡å™¨é¡¹ç›®ç›®å½•
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²ä¸´æ—¶åˆ†æ”¯ ${{ needs.create-temp-test-branch.outputs.tempBranch }} åˆ°Testç¯å¢ƒ"
          
          # ===================== æ›¿æ¢ä¸ºä½ çš„å®é™…éƒ¨ç½²å‘½ä»¤ =====================
          # ç¤ºä¾‹1ï¼šå‰ç«¯é¡¹ç›®ï¼ˆVue/React/Angularï¼‰éƒ¨ç½²åˆ°äº‘å‚å•†é™æ€æ‰˜ç®¡ï¼ˆå¦‚é˜¿é‡Œäº‘OSSã€Vercelï¼‰
          # npm install
          # npm run build
          # # é˜¿é‡Œäº‘OSSç¤ºä¾‹ï¼ˆéœ€å®‰è£…ossutilï¼‰
          # wget https://gosspublic.alicdn.com/ossutil/1.7.19/ossutil64 -O /usr/local/bin/ossutil
          # chmod +x /usr/local/bin/ossutil
          # ossutil config -i ${{ secrets.ALIYUN_ACCESS_KEY }} -k ${{ secrets.ALIYUN_SECRET_KEY }} -e oss-cn-beijing.aliyuncs.com
          # ossutil cp -r dist/ oss://ä½ çš„bucketåç§°/ --force
          
          # ç¤ºä¾‹2ï¼šåç«¯é¡¹ç›®ï¼ˆNode.js/Python/Javaï¼‰éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨ï¼ˆSSHæ–¹å¼ï¼‰
          # # å†™å…¥SSHå¯†é’¥å¹¶è®¾ç½®æƒé™
          # echo "$TEST_SERVER_SSH_KEY" > ~/.ssh/test_server_key
          # chmod 600 ~/.ssh/test_server_key
          # # SSHè¿æ¥æœåŠ¡å™¨å¹¶æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
          # ssh -o StrictHostKeyChecking=no -i ~/.ssh/test_server_key $TEST_SERVER_USER@$TEST_SERVER_HOST << EOF
          #   cd $TEST_SERVER_APP_DIR
          #   git pull origin ${{ needs.create-temp-test-branch.outputs.tempBranch }}
          #   # æ ¹æ®é¡¹ç›®ç±»å‹æ‰§è¡Œä¾èµ–å®‰è£…å’Œé‡å¯å‘½ä»¤
          #   npm install  # Node.jsé¡¹ç›®
          #   # pip install -r requirements.txt  # Pythoné¡¹ç›®
          #   # ./gradlew build  # Java Gradleé¡¹ç›®
          #   pm2 restart test-app  # é‡å¯æœåŠ¡ï¼ˆæ ¹æ®ä½ çš„è¿›ç¨‹ç®¡ç†å·¥å…·è°ƒæ•´ï¼‰
          # EOF
          
          # ç¤ºä¾‹3ï¼šDockerå®¹å™¨éƒ¨ç½²ï¼ˆæœ¬åœ°æ„å»ºé•œåƒæ¨é€åˆ°æµ‹è¯•ç¯å¢ƒï¼‰
          # # ç™»å½•Dockerä»“åº“ï¼ˆå¦‚é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ï¼‰
          # docker login --username ${{ secrets.DOCKER_USERNAME }} --password ${{ secrets.DOCKER_PASSWORD }} ä½ çš„é•œåƒä»“åº“åœ°å€
          # # æ„å»ºé•œåƒ
          # docker build -t ä½ çš„é•œåƒä»“åº“åœ°å€/test-app:${{ needs.create-temp-test-branch.outputs.tempBranch }} .
          # # æ¨é€é•œåƒ
          # docker push ä½ çš„é•œåƒä»“åº“åœ°å€/test-app:${{ needs.create-temp-test-branch.outputs.tempBranch }}
          # # è¿œç¨‹æœåŠ¡å™¨æ‹‰å–é•œåƒå¹¶é‡å¯å®¹å™¨
          # ssh -o StrictHostKeyChecking=no $TEST_SERVER_USER@$TEST_SERVER_HOST << EOF
          #   docker pull ä½ çš„é•œåƒä»“åº“åœ°å€/test-app:${{ needs.create-temp-test-branch.outputs.tempBranch }}
          #   docker-compose down && docker-compose up -d
          # EOF
          # ==============================================================

          echo "âœ… Testç¯å¢ƒéƒ¨ç½²å‘½ä»¤æ‰§è¡Œå®Œæˆï¼"

      # æ­¥éª¤4ï¼šéƒ¨ç½²ç»“æœé€šçŸ¥ï¼ˆå¯é€‰ï¼Œæ ¹æ®å›¢é˜Ÿéœ€æ±‚é…ç½®ï¼‰
      - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
        run: |
          # æ‹¼æ¥é€šçŸ¥å†…å®¹
          NOTIFY_CONTENT="ğŸ“¢ Testç¯å¢ƒéƒ¨ç½²å®Œæˆï¼
          - æ“ä½œç±»å‹ï¼š${{ github.event.inputs.action }}
          - ç›®æ ‡åˆ†æ”¯ï¼š${{ github.event.inputs.featureBranch }}
          - ä¸´æ—¶Teståˆ†æ”¯ï¼š${{ needs.create-temp-test-branch.outputs.tempBranch }}
          - å½“å‰é›†æˆåˆ†æ”¯ï¼š${{ needs.update-integration-list.outputs.currentFeatures }}
          - éƒ¨ç½²æ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S')"
          
          # è¾“å‡ºåˆ°æ—¥å¿—
          echo "$NOTIFY_CONTENT"
          
          # å¯é€‰ï¼šä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼ˆéœ€åœ¨GitHub Secretsæ·»åŠ  WECHAT_WEBHOOKï¼‰
          # if [ -n "${{ secrets.WECHAT_WEBHOOK }}" ]; then
          #   curl -H "Content-Type: application/json" -d "{
          #     \"msgtype\":\"text\",
          #     \"text\":{\"content\":\"$NOTIFY_CONTENT\"}
          #   }" ${{ secrets.WECHAT_WEBHOOK }}
          # fi
          
          # å¯é€‰ï¼šSlacké€šçŸ¥ï¼ˆéœ€æ·»åŠ  SLACK_WEBHOOKï¼‰
          # if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
          #   curl -H "Content-Type: application/json" -d "{
          #     \"text\":\"$NOTIFY_CONTENT\"
          #   }" ${{ secrets.SLACK_WEBHOOK }}
          # fi
