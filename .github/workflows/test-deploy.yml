name: Test Environment Deploy (No Tags + No Master Pollution)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'æ“ä½œç±»å‹'
        required: true
        type: choice
        options:
          - åŠ å…¥Testç¯å¢ƒ
          - é€€å‡ºTestç¯å¢ƒ
      featureBranch:
        description: 'Featureåˆ†æ”¯åï¼ˆæ ¼å¼ï¼šfeature/xxxï¼Œå¦‚ feature/user-loginï¼‰'
        required: true
        default: 'feature/user-login'
      deployNow:
        description: 'æ“ä½œåç«‹å³éƒ¨ç½²Testç¯å¢ƒï¼Ÿ'
        required: true
        type: boolean
        default: true

jobs:
  update-integration-list:
    runs-on: ubuntu-latest
    outputs:
      currentFeatures: ${{ steps.get-features.outputs.list }}
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq (JSON parser)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: æ¢å¤é›†æˆæ¸…å•ç¼“å­˜
        uses: actions/cache@v3
        id: cache-features
        with:
          path: .test-env/features.json
          key: ${{ runner.os }}-test-env-features
          restore-keys: |
            ${{ runner.os }}-test-env-features

      - name: åˆå§‹åŒ–é›†æˆæ¸…å•ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰
        run: |
          mkdir -p .test-env
          if [ ! -f .test-env/features.json ]; then
            printf "[]" > .test-env/features.json  # ç”¨printfé¿å…æ¢è¡Œ
            echo "âœ… åˆå§‹åŒ–é›†æˆæ¸…å•ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰"
          fi

      - name: æ›´æ–°é›†æˆæ¸…å•é€»è¾‘
        id: update-list
        run: |
          # ç”¨printfè¯»å–æ–‡ä»¶ï¼Œé¿å…å¤šä½™æ¢è¡Œ
          CURRENT_JSON=$(printf "%s" "$(cat .test-env/features.json)" | jq -c .)
          TARGET_BRANCH="${{ github.event.inputs.featureBranch }}"
          ACTION="${{ github.event.inputs.action }}"

          if [[ ! $TARGET_BRANCH =~ ^feature/ ]]; then
            echo "âŒ åˆ†æ”¯æ ¼å¼é”™è¯¯ï¼å¿…é¡»ä»¥ feature/ å¼€å¤´"
            exit 1
          fi

          # æ›´æ–°JSONæ•°ç»„
          if [ "$ACTION" == "åŠ å…¥Testç¯å¢ƒ" ]; then
            NEW_JSON=$(echo "$CURRENT_JSON" | jq --arg branch "$TARGET_BRANCH" -c '
              if index($branch) then . else . + [$branch] end
            ')
            echo "âœ… å·²å°† $TARGET_BRANCH åŠ å…¥Testç¯å¢ƒé›†æˆæ¸…å•"
          else
            NEW_JSON=$(echo "$CURRENT_JSON" | jq --arg branch "$TARGET_BRANCH" -c '
              map(select(. != $branch))
            ')
            echo "âœ… å·²å°† $TARGET_BRANCH é€€å‡ºTestç¯å¢ƒé›†æˆæ¸…å•"
          fi

          # ç”¨printfå†™å…¥æ–‡ä»¶ï¼Œç¡®ä¿æ— å¤šä½™ç©ºæ ¼/æ¢è¡Œ
          printf "%s" "$NEW_JSON" | jq . > .test-env/features.json
          # å…³é”®ä¿®å¤ï¼šç”¨printfè¾“å‡ºåˆ°GITHUB_OUTPUTï¼Œå¼•å·åŒ…è£¹JSON
          printf 'list="%s"\n' "$NEW_JSON" >> $GITHUB_OUTPUT

      - name: ä¿å­˜é›†æˆæ¸…å•åˆ°ç¼“å­˜
        if: always()
        uses: actions/cache/save@v3
        with:
          path: .test-env/features.json
          key: ${{ runner.os }}-test-env-features

      - name: è¾“å‡ºå½“å‰é›†æˆåˆ†æ”¯
        id: get-features
        run: |
          FINAL_LIST=$(printf "%s" "$(cat .test-env/features.json)" | jq -c .)
          # ç”¨printfåŒ…è£¹å¼•å·è¾“å‡ºï¼Œé¿å…æ ¼å¼é”™è¯¯
          printf 'list="%s"\n' "$FINAL_LIST" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ å½“å‰å¾…é›†æˆåˆ°Testç¯å¢ƒçš„åˆ†æ”¯ï¼š$FINAL_LIST"

  create-temp-test-branch:
    runs-on: ubuntu-latest
    needs: update-integration-list
    # ä¿®å¤æ¡ä»¶åˆ¤æ–­ï¼šç”¨fromJSONè§£ææ—¶ï¼ŒJSONå·²è¢«å¼•å·åŒ…è£¹ï¼Œéœ€æ­£ç¡®å¤„ç†
    if: ${{ github.event.inputs.deployNow == true && join(fromJSON(needs.update-integration-list.outputs.currentFeatures)) != '' }}
    outputs:
      tempBranch: ${{ steps.create-branch.outputs.name }}
    steps:
      - name: Checkout ä»£ç ï¼ˆåŸºäºmasterï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½®Gitèº«ä»½
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: åˆ›å»ºä¸´æ—¶Teståˆ†æ”¯
        id: create-branch
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          TEMP_BRANCH="temp-test-$TIMESTAMP"
          git checkout -b $TEMP_BRANCH master
          echo "name=$TEMP_BRANCH" >> $GITHUB_OUTPUT
          echo "âœ… åˆ›å»ºä¸´æ—¶Teståˆ†æ”¯ï¼š$TEMP_BRANCH"

      - name: åˆå¹¶æ¸…å•ä¸­çš„æ‰€æœ‰Featureåˆ†æ”¯
        run: |
          # è§£æJSONæ—¶ï¼Œè‡ªåŠ¨å¤„ç†å¼•å·åŒ…è£¹çš„æ ¼å¼
          FEATURES=$(echo '${{ needs.update-integration-list.outputs.currentFeatures }}' | jq -r '.[]')
          for BRANCH in $FEATURES; do
            if [ -z "$BRANCH" ]; then continue; fi
            echo "ğŸ”„ æ­£åœ¨åˆå¹¶åˆ†æ”¯ï¼š$BRANCH"
            git fetch origin $BRANCH:refs/remotes/origin/$BRANCH
            if ! git merge origin/$BRANCH --no-edit; then
              echo "âŒ åˆå¹¶ $BRANCH æ—¶å‘ç”Ÿå†²çªï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤è§£å†³ï¼š"
              echo "1. æœ¬åœ°æ‹‰å–ä¸´æ—¶åˆ†æ”¯ï¼šgit pull origin ${{ steps.create-branch.outputs.name }}"
              echo "2. è§£å†³å†²çªï¼šgit mergetool æˆ–æ‰‹åŠ¨ç¼–è¾‘å†²çªæ–‡ä»¶"
              echo "3. æäº¤å¹¶æ¨é€ï¼šgit add . && git commit -m 'fix: resolve merge conflict' && git push"
              echo "4. é‡æ–°è§¦å‘å·¥ä½œæµéƒ¨ç½²"
              exit 1
            fi
          done
          git push -u origin $TEMP_BRANCH

  deploy-to-test:
    runs-on: ubuntu-latest
    needs: create-temp-test-branch
    steps:
      - name: Checkout ä¸´æ—¶Teståˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-temp-test-branch.outputs.tempBranch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: éƒ¨ç½²åˆ°Testç¯å¢ƒ
        env:
          TEST_DB_URL: ${{ secrets.TEST_DB_URL }}
          TEST_API_KEY: ${{ secrets.TEST_API_KEY }}
          # TEST_SERVER_SSH_KEY: ${{ secrets.TEST_SERVER_SSH_KEY }}
          # TEST_SERVER_HOST: ${{ secrets.TEST_SERVER_HOST }}
          # TEST_SERVER_USER: ${{ secrets.TEST_SERVER_USER }}
          # TEST_SERVER_APP_DIR: ${{ secrets.TEST_SERVER_APP_DIR }}
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²ä¸´æ—¶åˆ†æ”¯ ${{ needs.create-temp-test-branch.outputs.tempBranch }} åˆ°Testç¯å¢ƒ"
          
          # ===================== æ›¿æ¢ä¸ºä½ çš„å®é™…éƒ¨ç½²å‘½ä»¤ =====================
          # ç¤ºä¾‹1ï¼šå‰ç«¯é¡¹ç›®ï¼ˆVue/Reactï¼‰
          # npm install && npm run build
          # ç¤ºä¾‹2ï¼šåç«¯é¡¹ç›®ï¼ˆSSHéƒ¨ç½²ï¼‰
          # echo "$TEST_SERVER_SSH_KEY" > ~/.ssh/test_server_key && chmod 600 ~/.ssh/test_server_key
          # ssh -o StrictHostKeyChecking=no -i ~/.ssh/test_server_key $TEST_SERVER_USER@$TEST_SERVER_HOST "cd $TEST_SERVER_APP_DIR && git pull origin ${{ needs.create-temp-test-branch.outputs.tempBranch }} && npm install && pm2 restart test-app"
          # ç¤ºä¾‹3ï¼šDockeréƒ¨ç½²
          # docker build -t test-app:$TEMP_BRANCH . && docker push ä½ çš„é•œåƒä»“åº“ && ssh $TEST_SERVER_USER@$TEST_SERVER_HOST "docker pull ä½ çš„é•œåƒä»“åº“ && docker-compose restart"
          # ==============================================================

          echo "âœ… Testç¯å¢ƒéƒ¨ç½²å‘½ä»¤æ‰§è¡Œå®Œæˆï¼"

      - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
        run: |
          NOTIFY_CONTENT="ğŸ“¢ Testç¯å¢ƒéƒ¨ç½²å®Œæˆï¼
          - æ“ä½œç±»å‹ï¼š${{ github.event.inputs.action }}
          - ç›®æ ‡åˆ†æ”¯ï¼š${{ github.event.inputs.featureBranch }}
          - ä¸´æ—¶Teståˆ†æ”¯ï¼š${{ needs.create-temp-test-branch.outputs.tempBranch }}
          - å½“å‰é›†æˆåˆ†æ”¯ï¼š${{ needs.update-integration-list.outputs.currentFeatures }}
          - éƒ¨ç½²æ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S')"
          echo "$NOTIFY_CONTENT"
          # å¯é€‰ï¼šä¼ä¸šå¾®ä¿¡/Slacké€šçŸ¥
          # curl -H "Content-Type: application/json" -d "{\"msgtype\":\"text\",\"text\":{\"content\":\"$NOTIFY_CONTENT\"}}" ${{ secrets.WECHAT_WEBHOOK }}
